import boto3
import json

REGION = 'eu-central-1'  # DR region
REPLICA_IDENTIFIER = 'your-dr-rds-replica-identifier'
PARAM_NAME = '/copilot/ecs-lampstack-servcie/dr/secrets/DB_HOST'

def lambda_handler(event, context):
    rds = boto3.client('rds', region_name=REGION)
    ssm = boto3.client('ssm', region_name=REGION)
    
    # Promote replica
    print("Promoting replica...")
    rds.promote_read_replica(DBInstanceIdentifier=REPLICA_IDENTIFIER)
    
    # Wait until promotion is done
    waiter = rds.get_waiter('db_instance_available')
    waiter.wait(DBInstanceIdentifier=REPLICA_IDENTIFIER)
    
    # Fetch new endpoint
    db_info = rds.describe_db_instances(DBInstanceIdentifier=REPLICA_IDENTIFIER)
    new_host = db_info['DBInstances'][0]['Endpoint']['Address']
    print(f"New host: {new_host}")
    
    # Update DB_HOST in Parameter Store
    ssm.put_parameter(
        Name=PARAM_NAME,
        Value=new_host,
        Overwrite=True,
        Type='String'
    )
    
    print("DB_HOST updated in Parameter Store.")

    return {
        'statusCode': 200,
        'body': f'Failover completed. New DB host: {new_host}'
    }
